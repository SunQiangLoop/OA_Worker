# Feature Specification: OA 工单审批系统

**Feature Branch**: `001-oa-approval-system`  
**Created**: 2026-02-02  
**Status**: Draft  
**Input**: User description: "开发一个 OA 工单审批系统 (Go + Gin + GORM + SQLite)。 1. **表单引擎 (Form Engine)** - 支持动态表单配置：单行文本、金额、日期区间、明细表格、附件。 - 数据库模型需要支持存储自定义的 JSON 表单数据。 2. **流程引擎 (Workflow Engine)** - 节点类型：发起人(Starter)、审批人(Approver)、抄送(CC)、条件分支(Condition)。 - 逻辑举例：当报销金额 > 5000时，流转到总经理；否则部门经理。 - 必须记录审批日志 (Approval Logs)。 3. **具体场景：费用报销 (Expense Reimbursement)** - 字段：报销类型（差旅/团建）、事由、总汇、明细（子表）、附件。 - 状态：Draft -> Pending -> Approved / Rejected。 - 使用 GORM 建模 (User, WorkflowTemplate, WorkflowInstance, ProcessNode)。 - 接口遵循 RESTful 规范。 - 字段使用中文注释。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 费用报销提交 (Priority: P1)

员工需要按公司配置的费用报销表单填写信息并提交审批，表单字段可根据业务配置变化（例如单行文本、金额、日期区间、明细表格、附件）。

**Why this priority**: 这是核心业务流程，能直接产生业务价值。

**Independent Test**: 通过创建一张报销单并提交，验证系统能保存表单数据并进入待审批状态。

**Acceptance Scenarios**:

1. **Given** 员工创建报销单并填写必填字段，**When** 提交报销单，**Then** 报销单状态变为待审批且表单内容可被完整查看。
2. **Given** 报销单仍为草稿，**When** 员工保存草稿，**Then** 报销单保持草稿状态且可再次编辑。

---

### User Story 2 - 条件审批流转 (Priority: P2)

审批人需要按照预设流程处理报销单，流程支持条件分支（例如金额超过阈值时由更高层级审批）。

**Why this priority**: 保障审批合规性，减少人工流转错误。

**Independent Test**: 用两笔不同金额的报销单触发不同路径，验证审批节点正确。

**Acceptance Scenarios**:

1. **Given** 报销金额低于阈值，**When** 提交审批，**Then** 流程指派给部门经理审批。
2. **Given** 报销金额高于阈值，**When** 提交审批，**Then** 流程指派给总经理审批。

---

### User Story 3 - 审批记录与抄送 (Priority: P3)

业务人员需要查看完整的审批记录与抄送信息，以便审计与追溯。

**Why this priority**: 审批可追溯性是企业合规要求。

**Independent Test**: 完成一笔审批后，检查是否能查看完整审批日志与抄送信息。

**Acceptance Scenarios**:

1. **Given** 报销单完成审批，**When** 用户查看审批记录，**Then** 能看到每一步的处理人、动作与时间。
2. **Given** 抄送节点被触发，**When** 被抄送人查看通知，**Then** 能看到相关报销单摘要与当前状态。

---

### Edge Cases

- 当表单配置新增字段后，旧报销单如何展示与导出？系统应保留原始提交内容并支持查看。
- 当条件规则缺失或配置错误时，提交应失败并提示可操作的错误信息。
- 当附件过多或单个附件过大时，系统应拒绝并提示限制。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持配置可变的表单字段类型，包括单行文本、金额、日期区间、明细表格、附件。
- **FR-002**: 系统必须保存并展示表单的自定义数据，且不会因配置变更而丢失历史数据。
- **FR-003**: 用户必须能够将报销单保存为草稿、提交审批、查看当前状态。
- **FR-004**: 系统必须支持流程节点类型：发起人、审批人、抄送、条件分支。
- **FR-005**: 系统必须根据条件规则进行流程分支，并将报销单指派到正确的审批节点。
- **FR-006**: 系统必须记录每一步审批日志，包括处理人、动作、时间与结果。
- **FR-007**: 用户必须能够查看审批日志与抄送记录。
- **FR-008**: 系统必须支持费用报销场景字段：报销类型（差旅/团建）、事由、总汇、明细（子表）、附件。
- **FR-009**: 系统必须支持报销单状态流转：草稿、待审批、已通过、已驳回。
- **FR-010**: 系统必须提供可审计的变更记录，以便追溯表单配置与流程配置的调整。

### Key Entities *(include if feature involves data)*

- **用户**: 提交或处理审批的人，包含姓名、部门、角色等基础信息。
- **流程模板**: 可复用的审批流程定义，包含节点类型与条件规则。
- **流程实例**: 单个报销单对应的执行流程，记录当前节点与状态。
- **流程节点**: 流程中的具体步骤，包含审批人/抄送人/条件等信息。
- **审批日志**: 每个节点的处理记录，用于审计与追溯。
- **表单定义**: 可配置的表单结构与字段规则。
- **表单数据**: 用户提交的具体表单内容与附件。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90% 的报销单可在 3 分钟内完成并成功提交。
- **SC-002**: 100% 的审批流程能依据金额规则正确分支。
- **SC-003**: 95% 的用户在首次使用时即可完成报销单提交且无阻塞问题。
- **SC-004**: 审批日志覆盖率达到 100%，所有审批动作均可追溯。

## Assumptions

- 系统已有用户身份与组织架构基础数据可供流程指派使用。
- 费用金额阈值与审批人规则由业务管理员在流程模板中配置。
- 报销类型枚举（差旅/团建）为当前业务范围，未来可扩展。
- 附件限制（数量与大小）由业务管理员配置并在界面提示。
